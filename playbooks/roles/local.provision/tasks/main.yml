---
- name: Preparing environment
  delegate_to: localhost
  connection: local
  become: false
  block:
    - name: Provision machines
      include_role:
        name: "provisioner.{{ site.provisioner }}"
        tasks_from: "{{ provision_action }}/main.yml"
      vars:
        data: "{{ config.provisioners[site.provisioner] }}"

    - name: Generate local files
      when: provision_action == 'create'
      run_once: true
      block:
        - name: Generate inventory file
          template:
            src: site_inventory.j2
            dest: ansible/site_inventory

        - name: Generate SSH config file
          template:
            src: ssh_config.j2
            dest: ansible/ssh_config

    - name: Cleanup files
      when: provision_action == 'destroy'
      run_once: true
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - ansible/site_inventory
        - ansible/ssh_config
